<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ÙÙ„ÙˆØ³ÙŠ Moumen - V13.2 (Cloud)</title>
  <meta name="theme-color" content="#4f46e5">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4338ca;
      --bg-body: #f1f5f9;
      --card-bg: #ffffff;
      --text-main: #0f172a;
      --input-bg: #f8fafc;
      --border-color: #e2e8f0;
    }
    body.dark-mode {
      --primary: #818cf8;
      --primary-dark: #3730a3;
      --bg-body: #0f172a;
      --card-bg: #1e293b;
      --text-main: #f1f5f9;
      --input-bg: #334155;
      --border-color: #475569;
    }

    body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Segoe UI', Tahoma, sans-serif; padding-bottom: 90px; user-select: none; transition: 0.3s; }
    .main-container { max-width: 600px; margin: 0 auto; padding: 15px; }
    .card { border: none; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); margin-bottom: 15px; background: var(--card-bg); color: var(--text-main); transition: 0.2s; }

    .form-control, .form-select { background-color: var(--input-bg) !important; color: var(--text-main) !important; border: 1px solid var(--border-color) !important; }
    .form-control:focus, .form-select:focus { box-shadow: none; border-color: var(--primary) !important; }

    .text-muted { color: #94a3b8 !important; }
    body.dark-mode .text-muted { color: #cbd5e1 !important; }

    .balance-card { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; position: relative; overflow: hidden; }
    .balance-card::after { content: ''; position: absolute; top: -50%; right: -20%; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; }

    .progress-bar-bg { background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; margin-top: 15px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background: #ffffff; width: 0%; transition: width 0.5s ease; }

    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card-bg); box-shadow: 0 -5px 20px rgba(0,0,0,0.05); display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; border-radius: 20px 20px 0 0; }
    .nav-item { text-align: center; color: #94a3b8; font-size: 0.7rem; cursor: pointer; transition: 0.2s; position: relative; }
    .nav-item.active { color: var(--primary); font-weight: bold; transform: translateY(-3px); }
    .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 4px; }
    .nav-item.active::after { content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background: var(--primary); border-radius: 50%; }

    .date-header { font-size: 0.85rem; color: var(--text-main); opacity: 0.7; margin: 15px 0 8px 5px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
    .date-header::before { content: ''; width: 8px; height: 8px; background: var(--primary); border-radius: 50%; display: inline-block; }

    .trans-item { transition: transform 0.1s; border-bottom: 1px solid var(--border-color); }
    .trans-item:active { transform: scale(0.98); background: rgba(0,0,0,0.02); }
    .trans-item:last-child { border-bottom: none; }

    .money-plus { color: #10b981; font-weight: bold; }
    .money-minus { color: #ef4444; font-weight: bold; }
    .money-trans { color: #f59e0b; font-weight: bold; }

    .mic-wrapper { position: relative; display: inline-block; width: 100%; }
    .mic-btn { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); cursor: pointer; padding: 5px; }
    .mic-btn.listening { color: #ef4444; animation: pulse 1s infinite; background: rgba(239, 68, 68, 0.1); border-radius: 50%; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

    .calc-modal { position: fixed; bottom: -100%; left: 0; width: 100%; background: var(--card-bg); z-index: 5000; border-radius: 25px 25px 0 0; padding: 25px; box-shadow: 0 -10px 50px rgba(0,0,0,0.2); transition: cubic-bezier(0.4, 0, 0.2, 1) 0.4s; color: var(--text-main); }
    .calc-modal.show { bottom: 0; }
    .calc-btn { width: 100%; height: 55px; font-size: 1.3rem; border-radius: 14px; border: none; background: var(--input-bg); margin-bottom: 10px; color: var(--text-main); font-weight: bold; }

    .tab-section { display: none; animation: slideUp 0.3s; }
    .tab-section.active { display: block; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .filter-chip { border: 1px solid var(--primary); color: var(--primary); background: transparent; padding: 5px 15px; border-radius: 50px; font-size: 0.8rem; cursor: pointer; transition: 0.2s; }
    .filter-chip.active { background: var(--primary); color: white; }

    .cursor-pointer { cursor: pointer; }
  </style>
</head>

<body>

  <div class="container main-container">
    <div class="d-flex justify-content-between align-items-center mb-4 pt-2">
      <div>
        <h4 class="fw-bold m-0" style="color: var(--primary);">ÙÙ„ÙˆØ³ÙŠ Moumen</h4>
        <small class="text-muted" style="font-size: 0.8rem;">V13.2 + Cloud Sync</small>
      </div>
      <button onclick="toggleDarkMode()" class="btn shadow-sm rounded-circle" style="width: 40px; height: 40px; background: var(--card-bg); color: var(--text-main); border: 1px solid var(--border-color);">
        <i class="fa-solid fa-moon"></i>
      </button>
    </div>

    <!-- HOME -->
    <div id="tab-home" class="tab-section active">
      <div class="card balance-card p-4 mb-3">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <small class="opacity-75">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­</small>
            <h1 id="netBalance" class="fw-bold my-1 display-4">0</h1>
          </div>
          <div class="bg-white bg-opacity-25 rounded p-2 text-center" style="min-width: 70px;">
            <small class="d-block" style="font-size: 0.7rem;">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</small>
            <strong id="monthName">--</strong>
          </div>
        </div>
        <div class="progress-bar-bg"><div id="budgetBar" class="progress-bar-fill"></div></div>
        <div class="d-flex justify-content-between mt-2 small opacity-75">
          <span>Ù…ØµØ±ÙˆÙØ§Øª: <span id="totalExp">0</span></span>
          <span>Ø¯Ø®Ù„: <span id="totalInc">0</span></span>
        </div>
      </div>

      <div id="entryCard" class="card p-3 border-0 shadow-sm">
        <div class="d-flex justify-content-center mb-3">
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="opType" id="radioExp" value="exp" checked onchange="toggleFormMode()">
            <label class="btn btn-outline-danger border-0 rounded-start-pill bg-opacity-10" for="radioExp">Ù…ØµØ±ÙˆÙ</label>
            <input type="radio" class="btn-check" name="opType" id="radioInc" value="inc" onchange="toggleFormMode()">
            <label class="btn btn-outline-success border-0 bg-opacity-10" for="radioInc">Ø¯Ø®Ù„</label>
            <input type="radio" class="btn-check" name="opType" id="radioTrans" value="trans" onchange="toggleFormMode()">
            <label class="btn btn-outline-warning border-0 rounded-end-pill bg-opacity-10" for="radioTrans">ØªØ­ÙˆÙŠÙ„</label>
          </div>
        </div>

        <div class="input-group mb-3 shadow-sm rounded-4 overflow-hidden">
          <button class="btn btn-light px-3" onclick="openCalc()" style="background: var(--input-bg); border-color: var(--border-color);"><i class="fa-solid fa-calculator text-primary"></i></button>
          <input type="number" id="inpAmount" class="form-control text-center fw-bold fs-3 border-0" placeholder="0.00">
        </div>
        <input type="hidden" id="editId">

        <div id="normalMode" class="row g-2 mb-2">
          <div class="col-6"><select id="inpCat" class="form-select border-0"></select></div>
          <div class="col-6"><select id="inpWallet" class="form-select border-0"></select></div>
        </div>

        <div id="transferMode" class="row g-2 mb-2" style="display: none;">
          <div class="col-6"><select id="walletFrom" class="form-select border-danger"></select></div>
          <div class="col-6"><select id="walletTo" class="form-select border-success"></select></div>
        </div>

        <div class="mic-wrapper mb-3">
          <input type="text" id="inpNote" class="form-control border-0 rounded-pill ps-3" style="padding-right: 40px;" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©...">
          <i class="fa-solid fa-microphone mic-btn" id="micIcon" onclick="startDictation()"></i>
        </div>

        <div class="row g-2 mb-3 align-items-center">
          <div class="col-7"><input type="date" id="inpDate" class="form-control border-0"></div>
          <div class="col-5">
            <div class="form-check form-switch d-flex align-items-center justify-content-end p-2 rounded" style="background: var(--input-bg);">
              <input class="form-check-input ms-2" type="checkbox" id="isRec">
              <label class="form-check-label small" for="isRec">ØªÙƒØ±Ø§Ø± Ø´Ù‡Ø±ÙŠ</label>
            </div>
          </div>
        </div>

        <div class="d-flex gap-2">
          <button onclick="saveTrans()" id="saveBtn" class="btn btn-primary w-100 fw-bold py-2 rounded-pill shadow-sm">Ø­ÙØ¸ <i class="fa-solid fa-check ms-2"></i></button>
          <button onclick="cancelEdit()" id="cancelBtn" class="btn btn-secondary w-50 rounded-pill d-none">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-2 px-1">
        <small class="fw-bold text-muted">Ø¢Ø®Ø± Ø§Ù„Ø­Ø±ÙƒØ§Øª</small>
        <small class="text-primary cursor-pointer" onclick="showTab('tab-history', document.querySelectorAll('.nav-item')[1])">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</small>
      </div>
      <div id="recentList" class="card p-0 overflow-hidden"></div>
    </div>

    <!-- HISTORY -->
    <div id="tab-history" class="tab-section">
      <div class="card p-3 mb-3 sticky-top" style="z-index: 900; top: 10px; border-radius: 15px; border: 1px solid var(--border-color);">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="m-0 fw-bold">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h5>
          <button onclick="clearAll()" class="btn btn-sm text-danger bg-danger bg-opacity-10 rounded-pill px-3">Ù…Ø³Ø­</button>
        </div>
        <div class="d-flex gap-2 overflow-auto py-1" style="white-space: nowrap;">
          <span class="filter-chip active" onclick="filterHistory('all', this)">Ø§Ù„ÙƒÙ„</span>
          <span class="filter-chip" onclick="filterHistory('inc', this)">Ø¯Ø®ÙˆÙ„</span>
          <span class="filter-chip" onclick="filterHistory('exp', this)">Ø®Ø±ÙˆØ¬</span>
        </div>
      </div>
      <div id="historyListContainer" style="padding-bottom: 20px;"></div>
    </div>

    <!-- STATS -->
    <div id="tab-stats" class="tab-section">
      <div class="card p-3">
        <h6 class="text-center fw-bold mb-3">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h6>
        <div style="height: 220px;"><canvas id="chartExp"></canvas></div>
      </div>
      <div class="card p-3 mt-2">
        <h6 class="fw-bold mb-3">Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸</h6>
        <div id="walletStats"></div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="tab-settings" class="tab-section">
      <!-- AUTH -->
      <div class="card p-3 mb-3">
        <h6 class="fw-bold border-bottom pb-2 mb-3">ğŸ‘¤ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ù…Ø²Ø§Ù…Ù†Ø©</h6>
        <div class="mb-2 small text-muted" id="authStatus">ØºÙŠØ± Ù…Ø³Ø¬Ù„</div>

        <div class="row g-2">
          <div class="col-12">
            <input id="authEmail" class="form-control" placeholder="Email" autocomplete="email">
          </div>
          <div class="col-12">
            <input id="authPass" type="password" class="form-control" placeholder="Password" autocomplete="current-password">
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-primary w-100" onclick="authLogin()">Ø¯Ø®ÙˆÙ„</button>
          <button class="btn btn-outline-primary w-100" onclick="authRegister()">ØªØ³Ø¬ÙŠÙ„</button>
        </div>

        <button class="btn btn-outline-danger w-100 mt-2" onclick="authLogout()">Ø®Ø±ÙˆØ¬</button>

        <div class="small text-muted mt-2">
          Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙØ­ÙØ¸ ÙÙŠ Firestore Ø¯Ø§Ø®Ù„ <b>users/UID/app/main</b>.
        </div>
      </div>

      <div class="card p-3 mb-3">
        <h6 class="fw-bold border-bottom pb-2 mb-3">âš™ï¸ Ø§Ù„ØªØ®ØµÙŠØµ</h6>
        <button class="btn w-100 mb-2 text-start p-3 rounded-3" style="background: var(--input-bg); color: var(--text-main);" onclick="addCustomItem('cat')"><i class="fa-solid fa-tag text-primary me-2"></i> Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ Ø¬Ø¯ÙŠØ¯</button>
        <button class="btn w-100 mb-2 text-start p-3 rounded-3" style="background: var(--input-bg); color: var(--text-main);" onclick="addCustomItem('wallet')"><i class="fa-solid fa-wallet text-success me-2"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø­ÙØ¸Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>

      <div class="card p-3">
        <h6 class="fw-bold border-bottom pb-2 mb-3">ğŸ’¾ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h6>
        <button onclick="exportToCSV()" class="btn btn-success w-100 mb-2 fw-bold"><i class="fa-solid fa-file-excel me-2"></i> ØªØµØ¯ÙŠØ± Excel</button>
        <div class="row g-2">
          <div class="col-6">
            <button onclick="backupData()" class="btn btn-outline-secondary w-100">Ø­ÙØ¸ Ù†Ø³Ø®Ø© ğŸ“¥</button>
          </div>
          <div class="col-6">
            <button onclick="document.getElementById('restoreFile').click()" class="btn btn-outline-primary w-100">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ğŸ“‚</button>
            <input type="file" id="restoreFile" hidden onchange="restoreData(this)">
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="showTab('tab-home', this)"><i class="fa-solid fa-house"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    <div class="nav-item" onclick="showTab('tab-history', this)"><i class="fa-solid fa-clock-rotate-left"></i> Ø§Ù„Ø³Ø¬Ù„</div>
    <div class="nav-item" onclick="showTab('tab-stats', this)"><i class="fa-solid fa-chart-pie"></i> Ø§Ù„ØªØ­Ù„ÙŠÙ„</div>
    <div class="nav-item" onclick="showTab('tab-settings', this)"><i class="fa-solid fa-gear"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
  </div>

  <div id="calcModal" class="calc-modal">
    <div class="d-flex justify-content-between mb-3">
      <h5 class="fw-bold m-0">Ø¢Ù„Ø© Ø­Ø§Ø³Ø¨Ø©</h5>
      <button onclick="closeCalc()" class="btn-close"></button>
    </div>
    <input type="text" id="calcDisp" class="form-control mb-3 text-end fs-2 border-0 rounded-3" readonly>
    <div class="row g-2">
      <div class="col-3"><button class="calc-btn" onclick="cIn('7')">7</button></div>
      <div class="col-3"><button class="calc-btn" onclick="cIn('8')">8</button></div>
      <div class="col-3"><button class="calc-btn" onclick="cIn('9')">9</button></div>
      <div class="col-3"><button class="calc-btn bg-warning bg-opacity-25 text-warning" onclick="cIn('/')">Ã·</button></div>
      <div class="col-3"><button class="calc-btn" onclick="cIn('4')">4</button></div>
      <div class="col-3"><button class="calc-btn" onclick="cIn('5')">5</button></div>
      <div class="col-3"><button class="calc-btn" onclick="cIn('6')">6</button></div>
      <div class="col-3"><button class="calc-btn bg-warning bg-opacity-25 text-warning" onclick="cIn('*')">Ã—</button></div>
      <div class="col-3"><button class="calc-btn" onclick="cIn('1')">1</button></div>
      <div class="col-3"><button class="calc-btn" onclick="cIn('2')">2</button></div>
      <div class="col-3"><button class="calc-btn" onclick="cIn('3')">3</button></div>
      <div class="col-3"><button class="calc-btn bg-warning bg-opacity-25 text-warning" onclick="cIn('-')">-</button></div>
      <div class="col-3"><button class="calc-btn bg-danger text-white" onclick="cClr()">C</button></div>
      <div class="col-3"><button class="calc-btn" onclick="cIn('0')">0</button></div>
      <div class="col-3"><button class="calc-btn bg-primary text-white" onclick="cEq()">=</button></div>
      <div class="col-3"><button class="calc-btn bg-warning bg-opacity-25 text-warning" onclick="cIn('+')">+</button></div>
    </div>
  </div>

  <!-- âœ… Firebase + App logic -->
  <script type="module">
    // ===== Firebase config (YOUR PROJECT) =====
    const firebaseConfig = {
      apiKey: "AIzaSyCVPDkW5PvEnW75QF5YBw04qPfs9Ng0i-o",
      authDomain: "moumen-7b216.firebaseapp.com",
      projectId: "moumen-7b216",
      storageBucket: "moumen-7b216.appspot.com",
      messagingSenderId: "891367913014",
      appId: "1:891367913014:web:8f6681bc03907206308a97"
    };

    // ===== Firebase SDK =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const dbCloud = getFirestore(app);

    // ===== App DB =====
    let db = {
      trans: [],
      recurring: [],
      config: {
        cats: { exp: ["Ø·Ø¹Ø§Ù…","Ù…ÙˆØ§ØµÙ„Ø§Øª","Ù…Ø§Ø±ÙƒØª","ÙÙˆØ§ØªÙŠØ±","ØªØ±ÙÙŠÙ‡","Ø¹Ù„Ø§Ø¬","Ù…Ù„Ø§Ø¨Ø³"], inc: ["Ø±Ø§ØªØ¨","ÙØ±ÙŠ Ù„Ø§Ù†Ø³","Ø£Ø±Ø¨Ø§Ø­","Ø£Ø®Ø±Ù‰"] },
        wallets: ["ÙƒØ§Ø´","ÙÙŠØ²Ø§","Ø¨Ù†Ùƒ","ÙÙˆØ¯Ø§ÙÙˆÙ†"]
      }
    };

    let charts = {};
    let currentFilter = "all";
    const LOCAL_KEY = "MoneyApp_Moumen_V13";
    let currentUser = null;

    function userDocRef(uid){
      return doc(dbCloud, "users", uid, "app", "main"); // users/{uid}/app/main
    }

    let syncTimer = null;
    function scheduleCloudSync(){
      if(!currentUser) return;
      clearTimeout(syncTimer);
      syncTimer = setTimeout(async () => {
        try {
          await setDoc(userDocRef(currentUser.uid), {
            data: db,
            updatedAt: serverTimestamp()
          }, { merge: true });
        } catch (e){
          console.warn("Cloud sync failed:", e);
        }
      }, 600);
    }

    async function pullFromCloud(uid){
      try {
        const snap = await getDoc(userDocRef(uid));
        if(snap.exists()){
          const cloudData = snap.data()?.data;
          if(cloudData && cloudData.trans && cloudData.config){
            db = cloudData;
            localStorage.setItem(LOCAL_KEY, JSON.stringify(db));
            Swal.fire({ toast:true, position:"top", timer:1500, showConfirmButton:false, icon:"success", title:"ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© â˜ï¸" });
          }
        } else {
          await setDoc(userDocRef(uid), {
            data: db,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          }, { merge: true });
        }
      } catch(e){
        console.warn("Pull from cloud failed:", e);
      }
    }

    // ===== Auth actions =====
    function setAuthStatus(){
      const el = document.getElementById("authStatus");
      if(!el) return;
      if(currentUser){
        el.innerHTML = `Ù…Ø³Ø¬Ù„: <b>${currentUser.email}</b> (Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø´ØºØ§Ù„Ø© â˜ï¸)`;
      } else {
        el.textContent = "ØºÙŠØ± Ù…Ø³Ø¬Ù„ (Ø§Ù„Ø¯Ø§ØªØ§ Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·)";
      }
    }

    window.authRegister = async function(){
      const email = document.getElementById("authEmail").value.trim();
      const pass  = document.getElementById("authPass").value.trim();
      if(!email || !pass) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯", "warning");
      try{
        await createUserWithEmailAndPassword(auth, email, pass);
        Swal.fire({ toast:true, position:"top", timer:1500, showConfirmButton:false, icon:"success", title:"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ…" });
      }catch(e){
        Swal.fire("Ø®Ø·Ø£", e.message, "error");
      }
    }

    window.authLogin = async function(){
      const email = document.getElementById("authEmail").value.trim();
      const pass  = document.getElementById("authPass").value.trim();
      if(!email || !pass) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯", "warning");
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        Swal.fire({ toast:true, position:"top", timer:1500, showConfirmButton:false, icon:"success", title:"ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…" });
      }catch(e){
        Swal.fire("Ø®Ø·Ø£", e.message, "error");
      }
    }

    window.authLogout = async function(){
      try{
        await signOut(auth);
        Swal.fire({ toast:true, position:"top", timer:1200, showConfirmButton:false, icon:"success", title:"ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬" });
      }catch(e){
        Swal.fire("Ø®Ø·Ø£", e.message, "error");
      }
    }

    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;
      setAuthStatus();
      if(currentUser){
        await pullFromCloud(currentUser.uid);
      }
      renderDropdowns();
      refreshUI();
    });

    // ===== Start =====
    window.addEventListener("load", () => {
      const saved = localStorage.getItem(LOCAL_KEY);
      if(saved) db = JSON.parse(saved);

      if(localStorage.getItem("darkMode") === "true") document.body.classList.add("dark-mode");

      document.getElementById("inpDate").valueAsDate = new Date();
      document.getElementById("monthName").innerText = new Date().toLocaleString("ar-EG", { month: "long" });

      renderDropdowns();
      refreshUI();
      setAuthStatus();
    });

    // ===== Voice input =====
    window.startDictation = function() {
      if ("webkitSpeechRecognition" in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = "ar-EG";
        const micIcon = document.getElementById("micIcon");
        recognition.onstart = () => { micIcon.classList.add("listening"); };
        recognition.onend = () => { micIcon.classList.remove("listening"); };
        recognition.onresult = (e) => {
          const transcript = e.results[0][0].transcript.toLowerCase();
          document.getElementById("inpNote").value = transcript;

          if (transcript.includes("Ø¯Ø®Ù„") || transcript.includes("Ù‚Ø¨Ø¶Øª")) {
            document.getElementById("radioInc").checked = true; toggleFormMode();
          } else if (transcript.includes("ØµØ±ÙØª") || transcript.includes("Ø¯ÙØ¹")) {
            document.getElementById("radioExp").checked = true; toggleFormMode();
          }

          const numbers = transcript.match(/\d+/g);
          if (numbers) document.getElementById("inpAmount").value = numbers[0];

          const type = document.getElementById("radioInc").checked ? "inc" : "exp";
          const cats = db.config.cats[type];
          cats.forEach(c => { if(transcript.includes(c)) document.getElementById("inpCat").value = c; });

          Swal.fire({ toast:true, position:"top", timer:1500, showConfirmButton:false, icon:"success", title:"ØªÙ… Ø§Ù„ÙÙ‡Ù… ğŸ™ï¸" });
        };
        recognition.start();
      } else {
        alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù…");
      }
    }

    // ===== Save transaction =====
    window.saveTrans = function() {
      const id = document.getElementById("editId").value;
      const amt = parseFloat(document.getElementById("inpAmount").value);
      if(!amt) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº", "warning");

      const type = document.querySelector('input[name="opType"]:checked').value;
      const date = document.getElementById("inpDate").value;
      const note = document.getElementById("inpNote").value;
      const isRec = document.getElementById("isRec").checked;

      let transData = { id: id ? parseInt(id) : Date.now(), type, amt, date, note };

      if(type === "trans") {
        transData.walletFrom = document.getElementById("walletFrom").value;
        transData.walletTo = document.getElementById("walletTo").value;
        transData.cat = "ØªØ­ÙˆÙŠÙ„";
      } else {
        transData.cat = document.getElementById("inpCat").value;
        transData.wallet = document.getElementById("inpWallet").value;
        if(isRec && !id) db.recurring.push({ id: Date.now(), type, amt, cat: transData.cat, wallet: transData.wallet, note });
      }

      if(id) {
        const idx = db.trans.findIndex(t => t.id == id);
        if(idx !== -1) db.trans[idx] = transData;
        cancelEdit();
      } else {
        db.trans.push(transData);
        document.getElementById("inpAmount").value = "";
        document.getElementById("inpNote").value = "";
        Swal.fire({ toast:true, position:"bottom", timer:1500, showConfirmButton:false, icon:"success", title:"ØªÙ… Ø§Ù„Ø­ÙØ¸" });
      }
      saveData();
    }

    // ===== UI render =====
    window.saveData = function() {
      localStorage.setItem(LOCAL_KEY, JSON.stringify(db));
      refreshUI();
      scheduleCloudSync();
    }

    window.refreshUI = function() {
      let total = 0, incSum = 0, expSum = 0;
      let wallets = {}; db.config.wallets.forEach(w => wallets[w] = 0);

      db.trans.forEach(t => {
        if(t.type === "inc") { total += t.amt; wallets[t.wallet] += t.amt; incSum += t.amt; }
        else if(t.type === "exp") { total -= t.amt; wallets[t.wallet] -= t.amt; expSum += t.amt; }
        else { wallets[t.walletFrom] -= t.amt; wallets[t.walletTo] += t.amt; }
      });

      document.getElementById("netBalance").innerText = total.toLocaleString();
      document.getElementById("totalInc").innerText = incSum.toLocaleString();
      document.getElementById("totalExp").innerText = expSum.toLocaleString();

      const ratio = incSum > 0 ? (expSum / incSum) * 100 : 0;
      const bar = document.getElementById("budgetBar");
      bar.style.width = Math.min(ratio, 100) + "%";
      bar.style.backgroundColor = ratio > 90 ? "#ef4444" : (ratio > 50 ? "#f59e0b" : "#ffffff");

      const recent = [...db.trans].reverse().slice(0, 3);
      const recList = document.getElementById("recentList");
      recList.innerHTML = "";
      recent.forEach(t => { recList.innerHTML += `<div class="p-3 border-bottom d-flex justify-content-between"><span class="small">${t.cat}</span><span class="small fw-bold">${t.amt}</span></div>`; });
      if(recent.length === 0) recList.innerHTML = '<div class="p-3 text-center small text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ø­Ø¯ÙŠØ«Ø©</div>';

      const wDiv = document.getElementById("walletStats");
      if(wDiv){
        wDiv.innerHTML = "";
        for(let w in wallets) wDiv.innerHTML += `<div class="d-flex justify-content-between border-bottom p-2"><span>${w}</span><strong>${wallets[w].toLocaleString()}</strong></div>`;
      }

      renderDynamicHistory();
    }

    window.filterHistory = function(type, btn) {
      currentFilter = type;
      document.querySelectorAll(".filter-chip").forEach(c => c.classList.remove("active"));
      btn.classList.add("active");
      renderDynamicHistory();
    }

    window.renderDynamicHistory = function() {
      const list = document.getElementById("historyListContainer");
      list.innerHTML = "";

      // ğŸ”’ If you want history to require login, keep this.
      // If you want local history visible without login, comment these 6 lines.
      if(!currentUser){
        list.innerHTML = `<div class="text-center text-muted py-5">
          <i class="fa-solid fa-lock fs-1 mb-2"></i><br>
          Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù„Ø´Ø§Ù† ØªØ´ÙˆÙ Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§ØªÙƒ
        </div>`;
        return;
      }

      let filtered = [...db.trans].reverse();
      if(currentFilter !== "all") filtered = filtered.filter(t => t.type === currentFilter);

      const grouped = {};
      filtered.forEach(t => { if(!grouped[t.date]) grouped[t.date] = []; grouped[t.date].push(t); });
      const dates = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));

      if(dates.length === 0) {
        list.innerHTML = `<div class="text-center text-muted py-5"><i class="fa-solid fa-wind fs-1 mb-2"></i><br>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>`;
        return;
      }

      dates.forEach(date => {
        let dateName = date;
        const today = new Date().toISOString().split("T")[0];
        const yesterday = new Date(Date.now() - 864e5).toISOString().split("T")[0];

        if(date === today) dateName = "Ø§Ù„ÙŠÙˆÙ…";
        else if(date === yesterday) dateName = "Ø£Ù…Ø³";
        else dateName = new Date(date).toLocaleDateString("ar-EG", {weekday:"long", day:"numeric", month:"long"});

        let groupHTML = `<div class="date-header">${dateName}</div><div class="card p-0 overflow-hidden mb-3">`;

        grouped[date].forEach(t => {
          let color = "text-main", sign = "", icon = "fa-circle-dot";
          if(t.type === "inc") { color = "money-plus"; sign = "+"; icon = "fa-arrow-down"; }
          else if(t.type === "exp") { color = "money-minus"; sign = "-"; icon = "fa-arrow-up"; }
          else { color = "money-trans"; sign = ""; icon = "fa-right-left"; }

          groupHTML += `
            <div class="d-flex justify-content-between align-items-center p-3 trans-item">
              <div class="d-flex align-items-center gap-3">
                <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: var(--input-bg); color: var(--text-main);">
                  <i class="fa-solid ${icon}"></i>
                </div>
                <div>
                  <div class="fw-bold" style="font-size: 0.95rem;">${t.cat}</div>
                  <div class="small text-muted" style="font-size: 0.75rem;">${t.walletFrom||t.wallet} ${t.note?'- '+t.note:''}</div>
                </div>
              </div>
              <div class="text-end">
                <div class="fw-bold ${color}">${sign}${t.amt.toLocaleString()}</div>
                <div class="small text-muted cursor-pointer" onclick="startEdit(${t.id})">ØªØ¹Ø¯ÙŠÙ„</div>
              </div>
            </div>`;
        });

        groupHTML += `</div>`;
        list.innerHTML += groupHTML;
      });
    }

    window.updateCharts = function() {
      let cats = {};
      db.trans.forEach(t => { if(t.type === "exp") cats[t.cat] = (cats[t.cat]||0) + t.amt; });
      const ctxP = document.getElementById("chartExp");
      if(charts.pie) charts.pie.destroy();
      charts.pie = new Chart(ctxP, {
        type: "doughnut",
        data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: ["#ef4444","#f59e0b","#10b981","#3b82f6","#8b5cf6","#6366f1"] }] },
        options: { maintainAspectRatio: false, plugins: { legend: { position: "right", labels: { color: document.body.classList.contains("dark-mode") ? "#f8fafc" : "#333" } } } }
      });
    }

    window.renderDropdowns = function() {
      const type = document.getElementById("radioInc").checked ? "inc" : "exp";
      const cats = db.config.cats[type];
      const wallets = db.config.wallets;
      const fill = (id, data) => {
        const el = document.getElementById(id);
        if(!el) return;
        el.innerHTML = "";
        data.forEach(x => el.innerHTML += `<option value="${x}">${x}</option>`);
      };
      fill("inpCat", cats);
      fill("inpWallet", wallets);
      fill("walletFrom", wallets);
      fill("walletTo", wallets);
    }

    // ===== Edit / misc =====
    window.startEdit = function(id) {
      const t = db.trans.find(x => x.id === id); if(!t) return;
      document.getElementById("editId").value = t.id;
      document.getElementById("inpAmount").value = t.amt;
      document.getElementById("inpDate").value = t.date;
      document.getElementById("inpNote").value = t.note || "";

      if(t.type === "trans") document.getElementById("radioTrans").click();
      else if(t.type === "inc") document.getElementById("radioInc").click();
      else document.getElementById("radioExp").click();

      document.getElementById("saveBtn").innerHTML = 'ØªØ­Ø¯ÙŠØ« <i class="fa-solid fa-rotate ms-2"></i>';
      document.getElementById("cancelBtn").classList.remove("d-none");
      showTab("tab-home");
    }

    window.cancelEdit = function() {
      document.getElementById("editId").value = "";
      document.getElementById("inpAmount").value = "";
      document.getElementById("inpNote").value = "";
      document.getElementById("saveBtn").innerHTML = 'Ø­ÙØ¸ <i class="fa-solid fa-check ms-2"></i>';
      document.getElementById("cancelBtn").classList.add("d-none");
    }

    window.clearAll = function() {
      if(confirm("Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ")) {
        localStorage.removeItem(LOCAL_KEY);
        location.reload();
      }
    }

    window.toggleDarkMode = function() {
      document.body.classList.toggle("dark-mode");
      localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
      updateCharts();
    }

    window.showTab = function(id, nav) {
      document.querySelectorAll(".tab-section").forEach(t => t.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if(nav){
        document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
        nav.classList.add("active");
      }
      if(id === "tab-stats") updateCharts();
    }

    window.toggleFormMode = function() {
      const type = document.querySelector('input[name="opType"]:checked').value;
      document.getElementById("normalMode").style.display = (type === "trans") ? "none" : "flex";
      document.getElementById("transferMode").style.display = (type === "trans") ? "flex" : "none";
      renderDropdowns();
    }

    window.addCustomItem = function(type) {
      const val = prompt("Ø§Ù„Ø§Ø³Ù…:");
      if(val) {
        if(type === "cat") db.config.cats.exp.push(val);
        else db.config.wallets.push(val);
        saveData();
        renderDropdowns();
      }
    }

    window.exportToCSV = function() {
      let csv = "\uFEFFØ§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ù†ÙˆØ¹,Ø§Ù„ØªØµÙ†ÙŠÙ,Ø§Ù„Ù…Ø¨Ù„Øº,Ù…Ù„Ø§Ø­Ø¸Ø§Øª\n";
      db.trans.forEach(t => csv += `${t.date},${t.type},${t.cat},${t.amt},${t.note||""}\n`);
      const a = document.createElement("a");
      a.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
      a.download = "Moumen_Money.csv";
      a.click();
    }

    window.backupData = function(){
      const a=document.createElement("a");
      a.href="data:json;charset=utf-8,"+encodeURIComponent(JSON.stringify(db));
      a.download="Moumen_Backup.json";
      a.click();
    }

    window.restoreData = function(input) {
      const file = input.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if(data.trans && data.config) {
            db = data;
            localStorage.setItem(LOCAL_KEY, JSON.stringify(db));
            scheduleCloudSync();
            Swal.fire({title:"ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹", icon:"success", timer:1500}).then(()=>location.reload());
          } else { Swal.fire("Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­", "", "error"); }
        } catch(err) { Swal.fire("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù", "", "error"); }
      };
      reader.readAsText(file);
    }

    // calculator
    let cStr="";
    window.openCalc = function(){document.getElementById("calcModal").classList.add("show");cStr="";document.getElementById("calcDisp").value="";}
    window.closeCalc = function(){document.getElementById("calcModal").classList.remove("show")}
    window.cIn = function(v){cStr+=v;document.getElementById("calcDisp").value=cStr}
    window.cEq = function(){try{document.getElementById("inpAmount").value=eval(cStr);closeCalc()}catch{}}
    window.cClr = function(){cStr="";document.getElementById("calcDisp").value=""}
  </script>
</body>
</html>
